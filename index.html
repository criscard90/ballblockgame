<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Arkanoid Ultra Edition</title>
    <style>
        body { margin: 0; background: #050505; color: #fff; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { border: 2px solid #0ff; box-shadow: 0 0 20px #0ff; background: #000; max-width: 100%; max-height: 100%; cursor: none; }
        #ui { position: absolute; top: 10px; left: 10px; pointer-events: none; text-shadow: 0 0 5px #0ff; font-weight: bold; z-index: 5; line-height: 1.5; }
        #gameOverScreen { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.9); padding: 30px; border: 2px solid #0ff; box-shadow: 0 0 30px #0ff; z-index: 10; }
        button { background: #0ff; border: none; padding: 10px 25px; font-weight: bold; color: #000; cursor: pointer; margin-top: 15px; letter-spacing: 1px; text-transform: uppercase; }
        .stat { color: #0ff; }
    </style>
</head>
<body>

    <div id="ui">
        LIVELLO: <span id="level" class="stat">1</span><br>
        PUNTI: <span id="score" class="stat">0</span><br>
        VITE: <span id="lives" class="stat">3</span><br>
        COMBO: <span id="combo" class="stat">x1</span>
    </div>
    
    <div id="gameOverScreen">
        <h1 style="color: #0ff; margin: 0;">GAME OVER</h1>
        <p style="font-size: 1.2rem;">Punteggio Finale: <span id="finalScore">0</span></p>
        <button onclick="location.reload()">RIPROVA</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const livesEl = document.getElementById('lives');
        const comboEl = document.getElementById('combo');

        canvas.width = window.innerWidth < 500 ? window.innerWidth - 20 : 480;
        canvas.height = window.innerHeight < 800 ? window.innerHeight - 100 : 640;

        // --- STATO DEL GIOCO ---
        let score = 0;
        let lives = 3;
        let currentLevel = 1;
        let combo = 1;
        let gameRunning = true;
        let shakeTime = 0;

        const paddle = { w: 90, h: 12, x: canvas.width / 2 - 45, y: canvas.height - 30, color: '#0ff' };
        let balls = [];
        let bricks = [];
        let powerUps = [];
        let particles = [];
        let floatingTexts = [];
        let stars = Array.from({length: 50}, () => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2, speed: Math.random() * 0.5 + 0.2 }));

        const brickConfig = { rows: 4, cols: 6, h: 25, padding: 8, offsetTop: 60 };

        function createBall(x, y, isExtra = false) {
            const angle = isExtra ? (Math.random() * Math.PI) - Math.PI : -Math.PI/4;
            const speed = 4 + (currentLevel * 0.2);
            return {
                radius: 7, x: x, y: y,
                dx: isExtra ? Math.cos(angle) * speed : speed,
                dy: isExtra ? Math.sin(angle) * speed : -speed,
                speed: speed, color: '#fff', isFire: false, fireTimer: 0,
                trail: [] // Scia della pallina
            };
        }

        function spawnText(x, y, txt, color = "#fff") {
            floatingTexts.push({ x, y, txt, color, life: 1.0 });
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 10; i++) {
                particles.push({ x, y, dx: (Math.random() - 0.5) * 8, dy: (Math.random() - 0.5) * 8, life: 1.0, color });
            }
        }

        function startShake(duration) { shakeTime = duration; }

        function generateLevel() {
            bricks = [];
            const colors = ['#f0f', '#0ff', '#0f0', '#ff0', '#f00'];
            let rows = Math.min(brickConfig.rows + Math.floor(currentLevel/2), 8);
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < brickConfig.cols; c++) {
                    let rand = Math.random();
                    let type = 'normal', hits = 1, color = colors[r % colors.length];
                    if (rand < 0.1) { type = 'steel'; color = '#888'; hits = 999; }
                    else if (rand < 0.25) { type = 'heavy'; color = '#ffa500'; hits = 3; }
                    bricks.push({ x: c * (canvas.width / brickConfig.cols) + brickConfig.padding/2, y: r * (brickConfig.h + brickConfig.padding) + brickConfig.offsetTop, w: (canvas.width / brickConfig.cols) - brickConfig.padding, h: brickConfig.h, color, origColor: color, type, hits, status: 1 });
                }
            }
        }

        // --- INPUT ---
        function movePaddle(clientX) {
            const rect = canvas.getBoundingClientRect();
            paddle.x = clientX - rect.left - paddle.w / 2;
            paddle.x = Math.max(0, Math.min(canvas.width - paddle.w, paddle.x));
        }
        canvas.addEventListener('touchmove', (e) => { movePaddle(e.touches[0].clientX); e.preventDefault(); }, { passive: false });
        canvas.addEventListener('mousemove', (e) => movePaddle(e.clientX));

        // --- LOGICA DI AGGIORNAMENTO ---
        function update() {
            if (!gameRunning) return;
            if (shakeTime > 0) shakeTime--;

            // Sfondo stellato
            stars.forEach(s => { s.y += s.speed; if(s.y > canvas.height) s.y = 0; });

            // Palline
            for (let i = balls.length - 1; i >= 0; i--) {
                let b = balls[i];
                
                // Aggiorna Scia
                b.trail.unshift({x: b.x, y: b.y});
                if(b.trail.length > 10) b.trail.pop();

                b.x += b.dx; b.y += b.dy;

                if (b.x + b.radius > canvas.width || b.x - b.radius < 0) { b.dx *= -1; startShake(2); }
                if (b.y - b.radius < 0) { b.dy *= -1; startShake(2); }

                if (b.y + b.radius > paddle.y && b.y < paddle.y + paddle.h && b.x > paddle.x && b.x < paddle.x + paddle.w) {
                    b.dy = -b.speed;
                    let hitPoint = (b.x - (paddle.x + paddle.w/2)) / (paddle.w/2);
                    b.dx = hitPoint * b.speed;
                    combo = 1; // Reset combo quando tocca il paddle
                    comboEl.innerText = "x" + combo;
                }

                bricks.forEach(brick => {
                    if (brick.status === 1 && b.x > brick.x && b.x < brick.x + brick.w && b.y > brick.y && b.y < brick.y + brick.h) {
                        if (!b.isFire || brick.type === 'steel') b.dy *= -1;
                        if (brick.type !== 'steel') {
                            if (b.isFire) { brick.hits = 0; startShake(10); } 
                            else { brick.hits--; if(brick.type === 'heavy') startShake(5); }

                            if (brick.hits <= 0) {
                                brick.status = 0;
                                let points = (brick.type === 'heavy' ? 30 : 10) * combo;
                                score += points;
                                spawnText(brick.x, brick.y, "+" + points, brick.origColor);
                                combo++;
                                scoreEl.innerText = score;
                                comboEl.innerText = "x" + combo;
                                createParticles(brick.x + brick.w/2, brick.y + brick.h/2, brick.origColor);
                                
                                if (Math.random() < 0.12) powerUps.push({ x: brick.x + brick.w/2, y: brick.y, w: 15, h: 15, type: Math.random() > 0.5 ? 'multi' : 'fire', color: Math.random() > 0.5 ? '#f0f' : '#ff4500' });
                            }
                        }
                    }
                });

                if (b.isFire) { b.fireTimer--; if (b.fireTimer <= 0) b.isFire = false; }
                if (b.y - b.radius > canvas.height) balls.splice(i, 1);
            }

            // Gestione Vite
            if (balls.length === 0) {
                lives--;
                livesEl.innerText = lives;
                if (lives > 0) {
                    balls.push(createBall(canvas.width / 2, paddle.y - 15));
                    combo = 1;
                    comboEl.innerText = "x1";
                } else {
                    gameRunning = false;
                    document.getElementById('gameOverScreen').style.display = 'block';
                    document.getElementById('finalScore').innerText = score;
                }
            }

            // Power-ups
            for (let i = powerUps.length - 1; i >= 0; i--) {
                let p = powerUps[i]; p.y += 3;
                if (p.y > paddle.y && p.y < paddle.y + paddle.h && p.x > paddle.x && p.x < paddle.x + paddle.w) {
                    if (p.type === 'multi') { balls.push(createBall(paddle.x, paddle.y - 10, true)); balls.push(createBall(paddle.x, paddle.y - 10, true)); }
                    else { balls.forEach(b => { b.isFire = true; b.fireTimer = 400; }); startShake(15); }
                    powerUps.splice(i, 1);
                } else if (p.y > canvas.height) powerUps.splice(i, 1);
            }

            // Testi e Particelle
            floatingTexts.forEach((t, i) => { t.y -= 1; t.life -= 0.02; if(t.life <= 0) floatingTexts.splice(i,1); });
            particles.forEach((p, i) => { p.x += p.dx; p.y += p.dy; p.life -= 0.02; if (p.life <= 0) particles.splice(i, 1); });

            if (bricks.length > 0 && bricks.filter(b => b.status === 1 && b.type !== 'steel').length === 0) {
                currentLevel++; levelEl.innerText = currentLevel;
                generateLevel(); balls = [createBall(canvas.width / 2, paddle.y - 10)];
            }
        }

        // --- DISEGNO ---
        function draw() {
            ctx.save();
            if (shakeTime > 0) ctx.translate((Math.random()-0.5)*7, (Math.random()-0.5)*7);

            // Sfondo con scia
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Stelle
            ctx.fillStyle = "#fff";
            stars.forEach(s => ctx.fillRect(s.x, s.y, s.size, s.size));

            // Mattoni
            bricks.forEach(b => {
                if (b.status === 1) {
                    ctx.shadowBlur = 10; ctx.shadowColor = b.color;
                    ctx.fillStyle = b.color;
                    ctx.fillRect(b.x, b.y, b.w, b.h);
                }
            });

            // Scia e Palline
            balls.forEach(b => {
                b.trail.forEach((pos, index) => {
                    ctx.fillStyle = b.isFire ? `rgba(255, 69, 0, ${1 - index/10})` : `rgba(255, 255, 255, ${0.5 - index/20})`;
                    ctx.beginPath(); ctx.arc(pos.x, pos.y, b.radius - (index * 0.5), 0, Math.PI*2); ctx.fill();
                });
                ctx.shadowBlur = b.isFire ? 20 : 10;
                ctx.shadowColor = b.isFire ? '#ff4500' : '#fff';
                ctx.fillStyle = b.isFire ? '#ff4500' : '#fff';
                ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2); ctx.fill();
            });

            // Paddle, Powerups e Particelle
            ctx.shadowBlur = 15; ctx.shadowColor = paddle.color; ctx.fillStyle = paddle.color;
            ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);

            powerUps.forEach(p => {
                ctx.shadowBlur = 15; ctx.shadowColor = p.color; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
            });

            // Testi fluttuanti
            ctx.shadowBlur = 0;
            floatingTexts.forEach(t => {
                ctx.fillStyle = `rgba(${hexToRgb(t.color)}, ${t.life})`;
                ctx.font = "bold 16px Arial";
                ctx.fillText(t.txt, t.x, t.y);
            });

            particles.forEach(p => {
                ctx.fillStyle = `rgba(${hexToRgb(p.color)}, ${p.life})`;
                ctx.fillRect(p.x, p.y, 3, 3);
            });

            ctx.restore();
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        
        balls.push(createBall(canvas.width / 2, paddle.y - 15));
        generateLevel();
        loop();
    </script>
</body>
</html>